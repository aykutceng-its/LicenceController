@{
    ViewData["Title"] = "Lisans Hatası";
	Layout = "~/Views/Shared/_LayoutNoBar.cshtml";
}
<form id="licenceForm" enctype="multipart/form-data">
    <div id="alertMessage" class="alert d-none"></div>
    
    <textarea name="publicKey" class="form-control" placeholder="Public Key yapıştırın..."></textarea>
    <input type="file" name="licenceFile" class="form-control mt-2" />
    
    <button type="submit" id="btnUpload" class="btn btn-primary mt-3">
        <span id="btnText">Lisansı Yükle</span>
        <span id="btnSpinner" class="spinner-border spinner-border-sm d-none"></span>
    </button>
</form>

@section Scripts {
    <script>
        $('#licenceForm').on('submit', function(e) {
            e.preventDefault(); // Sayfanın yenilenmesini engelle

            var formData = new FormData(this);
            var $btn = $('#btnUpload');
            var $alert = $('#alertMessage');

            // UI Hazırla
            $btn.prop('disabled', true);
            $('#btnText').text('Doğrulanıyor...');
            $('#btnSpinner').removeClass('d-none');
            $alert.addClass('d-none').removeClass('alert-danger alert-success');

            $.ajax({
                url: '@Url.Action("UploadLicence", "Licence")',
                type: 'POST',
                data: formData,
                processData: false, // FormData için şart
                contentType: false, // FormData için şart
                success: function(response) {
                    if (response.success) {
                        $alert.removeClass('d-none').addClass('alert-success').text('Lisans doğrulandı! Yönlendiriliyorsunuz...');
                        setTimeout(function() {
                            window.location.href = response.redirectUrl;
                        }, 1500);
                    } else {
                        $alert.removeClass('d-none').addClass('alert-danger').text(response.message);
                        resetButton();
                    }
                },
                error: function() {
                    $alert.removeClass('d-none').addClass('alert-danger').text('Sunucuyla iletişim kurulurken hata oluştu.');
                    resetButton();
                }
            });

            function resetButton() {
                $btn.prop('disabled', false);
                $('#btnText').text('Lisansı Yükle');
                $('#btnSpinner').addClass('d-none');
            }
        });
    </script>
}